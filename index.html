<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<title>Culinary Duo</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Arial;background:#fff8f0;color:#333;}
  .screen{height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:20px;box-sizing:border-box}
  button{padding:12px 24px;margin:8px;border:none;border-radius:8px;font-size:1em;cursor:pointer}
  .chef{background:#ffcc80}
  .mgr{background:#81c784;color:#fff}
  #copyBtn{background:#4fc3f7;color:#fff}
  .log{background:#f1f8e9;padding:6px;margin-top:8px;font-size:.85em;border-radius:4px;max-height:200px;overflow-y:auto}
  .hide{display:none}
</style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏ -->
<div id="chooseScreen" class="screen">
  <h1>Culinary Duo</h1>
  <p>–í—ã–±–µ—Ä–∏ —Å–≤–æ—é —Ä–æ–ª—å:</p>
  <button class="chef" onclick="chooseRole('chef')">üë®‚Äçüç≥ –®–µ—Ñ-–ø–æ–≤–∞—Ä</button>
  <button class="mgr"  onclick="chooseRole('manager')">ü§µ –ú–µ–Ω–µ–¥–∂–µ—Ä</button>
</div>

<!-- –≠–∫—Ä–∞–Ω –æ–∂–∏–¥–∞–Ω–∏—è / –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è -->
<div id="inviteScreen" class="screen hide">
  <h2 id="roleTitle"></h2>
  <p>–ö–æ–º–Ω–∞—Ç–∞: <b id="roomIdDisplay"></b></p>
  <button id="copyBtn" onclick="shareLink()">üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</button>
  <p id="waitText">–û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞‚Ä¶</p>
</div>

<!-- –≠–∫—Ä–∞–Ω –∏–≥—Ä—ã -->
<div id="gameScreen" class="screen hide">
  <div id="money">üí∞ 0</div>
  <div id="buttons"></div>
  <div class="log" id="log"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
/* === –¢–í–û–Ø FIREBASE-–ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø === */
const firebaseConfig = {
  apiKey: "AIzaSyA00nPNOm9OIXcqIv-Ls4lxwUnPzHM7TE0",
  authDomain: "culinary-duo-80f1f.firebaseapp.com",
  databaseURL: "https://culinary-duo-80f1f-default-rtdb.firebaseio.com",
  projectId: "culinary-duo-80f1f",
  storageBucket: "culinary-duo-80f1f.firebasestorage.app",
  messagingSenderId: "580643606813",
  appId: "1:580643606813:web:b38b69e952bf21187bd1f4",
  measurementId: "G-W4C40CY37G"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
/* ---------------------------------- */

/* Telegram Web App */
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

/* –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ */
let roomId, role, state = {}, dbRef;

/* –≤—ã–±–æ—Ä —Ä–æ–ª–∏ */
function chooseRole(r){
  role = r;
  roomId = new URLSearchParams(location.search).get('room') || genRoom();
  history.replaceState({}, '', '?room=' + roomId);
  dbRef = db.ref(roomId);

  document.getElementById('chooseScreen').classList.add('hide');
  document.getElementById('inviteScreen').classList.remove('hide');
  document.getElementById('roleTitle').textContent = role === 'chef' ? 'üë®‚Äçüç≥ –®–µ—Ñ-–ø–æ–≤–∞—Ä' : 'ü§µ –ú–µ–Ω–µ–¥–∂–µ—Ä';
  document.getElementById('roomIdDisplay').textContent = roomId;

  /* —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∏–≥—Ä–æ–∫–∞ –∏ –∂–¥—ë–º –≤—Ç–æ—Ä–æ–≥–æ */
  dbRef.child('players').on('value', snap => {
    const players = snap.val() || {};
    players[role] = true;
    dbRef.child('players').update(players);

    if(Object.keys(players).length === 2){
      document.getElementById('inviteScreen').classList.add('hide');
      document.getElementById('gameScreen').classList.remove('hide');
      startGame();
    }
  });
}

function genRoom(){
  return Math.random().toString(36).substr(2,4).toUpperCase();
}

/* –∫–Ω–æ–ø–∫–∞ ¬´–ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å¬ª –≤ Telegram */
function shareLink(){
  const url = location.origin + location.pathname + '?room=' + roomId;
  if(tg && tg.shareLink){
    tg.shareLink(url, '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –º–æ–µ–π –∏–≥—Ä–µ Culinary Duo!');
  }else{
    navigator.clipboard.writeText(url);
    alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞: ' + url);
  }
}

/* —Å—Ç–∞—Ä—Ç –∏–≥—Ä—ã */
function startGame(){
  dbRef.on('value', snap => {
    state = snap.val() || {money:100,ingredients:0,recipes:[],ovenBroken:false};
    document.getElementById('money').textContent = `üí∞ ${state.money}`;
    renderButtons();
  });
}

function patch(updateObj){
  dbRef.update(updateObj);
}

function renderButtons(){
  const box = document.getElementById('buttons');
  box.innerHTML='';
  if(role==='chef'){
    box.innerHTML += `<button class="chef" onclick="buyIng()">–ö—É–ø–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (-10)</button>`;
    box.innerHTML += `<button class="chef" onclick="createRec()">–°–æ–∑–¥–∞—Ç—å –±–ª—é–¥–æ (-20)</button>`;
    if(state.ovenBroken) box.innerHTML += `<button class="chef" onclick="fixOv()">–ü–æ—á–∏–Ω–∏—Ç—å –¥—É—Ö–æ–≤–∫—É (-15)</button>`;
  }else{
    box.innerHTML += `<button class="mgr" onclick="setPrice()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É</button>`;
    box.innerHTML += `<button class="mgr" onclick="campaign()">–†–µ–∫–ª–∞–º–Ω–∞—è –∫–∞–º–ø–∞–Ω–∏—è (-10)</button>`;
    box.innerHTML += `<button class="mgr" onclick="rush()">–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–æ–≤ (-5)</button>`;
  }
}

/* –ª–æ–≥–∏–∫–∞ —à–µ—Ñ–∞ */
function buyIng(){
  const cost=10;
  if((state.money||0)<cost)return alert('–ù–µ—Ç –¥–µ–Ω–µ–≥');
  patch({money:state.money-cost,ingredients:(state.ingredients||0)+1});
  log('–ö—É–ø–ª–µ–Ω—ã –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã');
}
function createRec(){
  if((state.ingredients||0)<1)return alert('–ù–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤');
  const cost=20;
  if((state.money||0)<cost)return alert('–ù–µ—Ç –¥–µ–Ω–µ–≥');
  const name=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞');
  if(!name)return;
  const recipes=[...state.recipes||[],{name,price:0}];
  patch({money:state.money-cost,ingredients:state.ingredients-1,recipes});
  log(`–°–æ–∑–¥–∞–Ω–æ –±–ª—é–¥–æ ¬´${name}¬ª`);
}
function fixOv(){
  if(!state.ovenBroken)return alert('–ù–µ —Å–ª–æ–º–∞–Ω–∞');
  const cost=15;
  if((state.money||0)<cost)return alert('–ù–µ—Ç –¥–µ–Ω–µ–≥');
  patch({money:state.money-cost,ovenBroken:false});
  log('–î—É—Ö–æ–≤–∫–∞ –ø–æ—á–∏–Ω–µ–Ω–∞');
}

/* –ª–æ–≥–∏–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ */
function setPrice(){
  const dish=(state.recipes||[]).find(r=>!r.price);
  if(!dish)return alert('–ù–µ—Ç –Ω–æ–≤—ã—Ö –±–ª—é–¥');
  const price=+prompt(`–¶–µ–Ω–∞ –¥–ª—è ¬´${dish.name}¬ª`);
  if(!price)return;
  dish.price=price;
  patch({recipes:state.recipes});
  log(`–¶–µ–Ω–∞ ${price} –¥–ª—è ¬´${dish.name}¬ª`);
}
function campaign(){
  const cost=10;
  if((state.money||0)<cost)return alert('–ù–µ—Ç –¥–µ–Ω–µ–≥');
  patch({money:state.money-cost,campaign:Date.now()});
  log('–ö–∞–º–ø–∞–Ω–∏—è –∑–∞–ø—É—â–µ–Ω–∞');
}
function rush(){
  const cost=5;
  if((state.money||0)<cost)return alert('–ù–µ—Ç –¥–µ–Ω–µ–≥');
  patch({money:state.money-cost,rush:Date.now()});
  log('–û—Ñ–∏—Ü–∏–∞–Ω—Ç—ã —Ä–∞—Å—Å—Ç–∞–≤–ª–µ–Ω—ã');
}

/* —Å–∏–º—É–ª—è—Ü–∏—è –ø—Ä–æ–¥–∞–∂ –∏ –ø–æ–ª–æ–º–æ–∫ */
setInterval(()=>{
  if(!dbRef) return;
  let newState={...state};

  if(Math.random()<0.03 && !newState.ovenBroken){
    newState.ovenBroken=true;
    log('‚ö†Ô∏è –î—É—Ö–æ–≤–∫–∞ —Å–ª–æ–º–∞–ª–∞—Å—å');
  }

  (newState.recipes||[]).forEach(d=>{
    if(!d.price) return;
    let sold = Math.floor(Math.random()*3);
    if(newState.campaign && Date.now()-newState.campaign<10000) sold*=2;
    if(newState.ovenBroken) sold=0;
    if(sold){
      d.sold=(d.sold||0)+sold;
      newState.money+=sold*d.price;
      log(`–ü—Ä–æ–¥–∞–Ω–æ ${sold} √ó ¬´${d.name}¬ª`);
    }
  });

  patch(newState);
}, 3000);

function log(text){
  const d=document.getElementById('log');
  d.textContent=text+'\n'+d.textContent.slice(0,300);
}
</script>
</body>
</html>
