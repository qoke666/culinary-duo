<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<title>Culinary Duo: Overcooked style</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
  html,body{margin:0;height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,Arial;background:#111;color:#fff}
  /* –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é */
  #mainMenu{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;background:#222}
  #mainMenu button{width:220px;margin:12px;padding:16px;font-size:1.2em;border:none;border-radius:8px;cursor:pointer}
  .playBtn{background:#ff7043;color:#fff}
  .joinBtn{background:#81c784;color:#fff}
  /* –º–æ–¥–∞–ª–∫–∞ –≤–≤–æ–¥–∞ –∫–æ–¥–∞ */
  #joinModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);justify-content:center;align-items:center}
  #joinBox{background:#fff;color:#000;padding:30px;border-radius:10px;text-align:center}
  #joinBox input{padding:10px;font-size:1.2em;width:120px;text-align:center}
  #joinBox button{margin:6px}
  /* –∏–≥—Ä–∞ */
  #gameCanvas{background:#222;display:block;margin:0 auto;image-rendering:pixelated}
  #hud{position:absolute;top:4px;left:4px;color:#fff;font-size:16px;text-shadow:1px 1px 0 #000}
</style>
</head>
<body>

<!-- 1. –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
<div id="mainMenu">
  <h1>Culinary Duo</h1>
  <button class="playBtn" onclick="createRoom()">–ò–≥—Ä–∞—Ç—å</button>
  <button class="joinBtn" onclick="openJoinModal()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
</div>

<!-- 2. –ú–æ–¥–∞–ª–∫–∞ –≤–≤–æ–¥–∞ –∫–æ–¥–∞ -->
<div id="joinModal">
  <div id="joinBox">
    <h2>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã</h2>
    <input id="roomInput" maxlength="4" placeholder="ABCD"/>
    <br>
    <button onclick="joinRoom()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
    <button onclick="closeJoinModal()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- 3. –ò–≥—Ä–∞ -->
<canvas id="gameCanvas"></canvas>
<div id="hud" style="display:none">üí∞ <span id="score">0</span> | ‚è±Ô∏è <span id="timer">120</span></div>

<script>
/* === Firebase === */
const firebaseConfig = {
  apiKey: "AIzaSyA00nPNOm9OIXcqIv-Ls4lxwUnPzHM7TE0",
  authDomain: "culinary-duo-80f1f.firebaseapp.com",
  databaseURL: "https://culinary-duo-80f1f-default-rtdb.firebaseio.com",
  projectId: "culinary-duo-80f1f",
  storageBucket: "culinary-duo-80f1f.firebasestorage.app",
  messagingSenderId: "580643606813",
  appId: "1:580643606813:web:b38b69e952bf21187bd1f4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const tg = window.Telegram.WebApp; tg.ready(); tg.expand();

let roomId, role, dbRef;

/* ---------------- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ ---------------- */
function createRoom(){
  roomId = genRoom();
  chooseRoleScreen();
}
function openJoinModal(){
  document.getElementById('joinModal').style.display='flex';
  document.getElementById('roomInput').focus();
}
function closeJoinModal(){
  document.getElementById('joinModal').style.display='none';
}
function joinRoom(){
  const code = document.getElementById('roomInput').value.trim().toUpperCase();
  if(!code){alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥!');return}
  roomId = code;
  closeJoinModal();
  chooseRoleScreen();
}
function genRoom(){
  return Math.random().toString(36).substr(2,4).toUpperCase();
}

/* ---------------- –≤—ã–±–æ—Ä —Ä–æ–ª–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–Ω–∞—Ç—ã ---------------- */
function chooseRoleScreen(){
  document.getElementById('mainMenu').style.display='none';
  const div = document.createElement('div');
  div.id = 'rolePick';
  div.style.cssText='position:fixed;inset:0;background:#222;display:flex;flex-direction:column;justify-content:center;align-items:center;color:#fff';
  div.innerHTML = `
    <h2>–ö–æ–º–Ω–∞—Ç–∞: ${roomId}</h2>
    <button class="playBtn" onclick="pickRole('chef')">üë®‚Äçüç≥ –®–µ—Ñ-–ø–æ–≤–∞—Ä</button>
    <button class="joinBtn"  onclick="pickRole('manager')">ü§µ –ú–µ–Ω–µ–¥–∂–µ—Ä</button>
    <button onclick="copyInvite()">üîó –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</button>
  `;
  document.body.appendChild(div);
}
function copyInvite(){
  const url = location.origin + location.pathname + '?room=' + roomId;
  if(tg.shareLink){tg.shareLink(url,'–°—ã–≥—Ä–∞–π —Å–æ –º–Ω–æ–π!')}
  else{navigator.clipboard.writeText(url);alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: '+url)}
}
function pickRole(r){
  role = r;
  dbRef = db.ref(roomId);
  document.getElementById('rolePick').remove();
  document.getElementById('hud').style.display='block';

  dbRef.child('players').update({[r]:true});
  dbRef.child('players').on('value', snap=>{
    if(Object.keys(snap.val()||{}).length===2) startGame();
  });
}

/* ---------------- Overcooked-–∏–≥—Ä–∞ ---------------- */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE = 40, W = 20, H = 15;
canvas.width = TILE*W; canvas.height = TILE*H;

let state = {
  players:{chef:{x:2,y:7,item:null},manager:{x:17,y:7,item:null}},
  ingredients:[{x:1,y:1,type:'tomato'},{x:1,y:13,type:'dough'}],
  plates:[{x:9,y:7,status:'empty'}],
  orders:[],
  score:0,
  timer:120
};

function startGame(){
  dbRef.on('value',snap=>{if(snap.exists())state=snap.val();render();});
  window.addEventListener('keydown',handleKey);
  setInterval(()=>{
    if(state.timer>0){
      state.timer--;
      dbRef.update({timer:state.timer});
      document.getElementById('timer').textContent=state.timer;
    }
  },1000);
}

function handleKey(e){
  const me=state.players[role]; if(!me)return;
  let dx=0,dy=0;
  if(e.key==='ArrowUp'||e.key==='w')dy=-1;
  if(e.key==='ArrowDown'||e.key==='s')dy=1;
  if(e.key==='ArrowLeft'||e.key==='a')dx=-1;
  if(e.key==='ArrowRight'||e.key==='d')dx=1;
  if(dx||dy){
    const nx=me.x+dx,ny=me.y+dy;
    if(nx>=0&&nx<W&&ny>=0&&ny<H){me.x=nx;me.y=ny;checkInteraction();dbRef.child('players').update(state.players);}
  }
}
function checkInteraction(){
  const me=state.players[role];
  const on=(arr)=>arr.find(o=>o.x===me.x&&o.y===me.y);

  /* –±–µ—Ä—ë–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç */
  const ing=on(state.ingredients);
  if(ing&&!me.item){me.item=ing.type;state.ingredients=state.ingredients.filter(i=>i!==ing);dbRef.update({ingredients:state.ingredients});}

  /* –∫–ª–∞–¥—ë–º –Ω–∞ –ø–ª–∏—Ç—É */
  const plate=on(state.plates);
  if(plate&&me.item&&plate.status==='empty'){
    plate.status='cooking_'+me.item; me.item=null;
    dbRef.update({plates:state.plates});
    setTimeout(()=>{plate.status='ready'; dbRef.update({plates:state.plates});},3000);
  }
  /* –º–µ–Ω–µ–¥–∂–µ—Ä –æ—Ç–Ω–æ—Å–∏—Ç –∫–ª–∏–µ–Ω—Ç—É */
  if(role==='manager'&&plate&&plate.status==='ready'){
    state.score+=10; plate.status='empty';
    dbRef.update({score:state.score,plates:state.plates});
    document.getElementById('score').textContent=state.score;
  }
}
function render(){
  ctx.fillStyle='#222'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#555';
  for(let i=0;i<W;i++)for(let j=0;j<H;j++)ctx.fillRect(i*TILE,j*TILE,TILE-1,TILE-1);

  /* —Ä–∏—Å—É–µ–º –æ–±—ä–µ–∫—Ç—ã */
  state.ingredients.forEach(i=>{ctx.fillStyle=i.type==='tomato'?'#f44336':'#ffeb3b';ctx.fillRect(i.x*TILE+5,i.y*TILE+5,TILE-10,TILE-10);});
  state.plates.forEach(p=>{ctx.fillStyle=p.status==='empty'?'#999':p.status.includes('cooking')?'#ff9800':'#4caf50';ctx.fillRect(p.x*TILE+5,p.y*TILE+5,TILE-10,TILE-10);});
  ['chef','manager'].forEach(r=>{const p=state.players[r];if(!p)return;ctx.fillStyle=r==='chef'?'#ff7043':'#81c784';ctx.fillRect(p.x*TILE+2,p.y*TILE+2,TILE-4,TILE-4);if(p.item){ctx.fillStyle='#fff';ctx.fillRect(p.x*TILE+TILE/2-4,p.y*TILE+TILE/2-4,8,8);}});
}
</script>
</body>
</html>
