<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<title>Culinary Duo: Overcooked style</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
  html,body{margin:0;height:100%;overflow:hidden;font-family:Arial}
  #gameCanvas{background:#222;display:block;margin:0 auto;image-rendering:pixelated}
  #hud{position:absolute;top:4px;left:4px;color:#fff;font-size:16px;text-shadow:1px 1px 0 #000}
  #rolePick{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:20px;border-radius:8px;text-align:center}
  button{margin:6px;padding:10px 20px;border:none;border-radius:6px;font-size:1em;cursor:pointer}
  .chefBtn{background:#ff7043;color:#fff}
  .mgrBtn{background:#81c784;color:#fff}
</style>
</head>
<body>
<!-- –≤—ã–±–æ—Ä —Ä–æ–ª–∏ -->
<div id="rolePick">
  <h2>üë®‚Äçüç≥ü§µ –í—ã–±–µ—Ä–∏ —Ä–æ–ª—å</h2>
  <button class="chefBtn" onclick="pickRole('chef')">–®–µ—Ñ-–ø–æ–≤–∞—Ä</button>
  <button class="mgrBtn"  onclick="pickRole('manager')">–ú–µ–Ω–µ–¥–∂–µ—Ä</button>
  <p id="inviteText" style="display:none">–ö–æ–º–Ω–∞—Ç–∞: <b id="roomCode"></b>
  <br><button onclick="shareInvite()">üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</button></p>
</div>

<canvas id="gameCanvas"></canvas>
<div id="hud">üí∞ <span id="score">0</span> | ‚è±Ô∏è <span id="timer">120</span></div>

<script>
/* === Firebase config === */
const firebaseConfig = {
  apiKey: "AIzaSyA00nPNOm9OIXcqIv-Ls4lxwUnPzHM7TE0",
  authDomain: "culinary-duo-80f1f.firebaseapp.com",
  databaseURL: "https://culinary-duo-80f1f-default-rtdb.firebaseio.com",
  projectId: "culinary-duo-80f1f",
  storageBucket: "culinary-duo-80f1f.firebasestorage.app",
  messagingSenderId: "580643606813",
  appId: "1:580643606813:web:b38b69e952bf21187bd1f4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* === –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ === */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE = 40;
const W = 20, H = 15;
canvas.width  = TILE * W;
canvas.height = TILE * H;

let roomId, role, dbRef;
const tg = window.Telegram.WebApp;
tg.ready(); tg.expand();

/* === –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–º–Ω–∞—Ç—ã === */
function genRoom(){ return Math.random().toString(36).substr(2,4).toUpperCase(); }

/* === –≤—ã–±–æ—Ä —Ä–æ–ª–∏ === */
function pickRole(r){
  role = r;
  roomId = new URLSearchParams(location.search).get('room') || genRoom();
  history.replaceState({},'','?room='+roomId);
  dbRef = db.ref(roomId);

  document.getElementById('rolePick').innerHTML =
    `<h2>${r==='chef'?'üë®‚Äçüç≥':'ü§µ'} –ñ–¥—ë–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞‚Ä¶</h2>
     <p>–ö–æ–º–Ω–∞—Ç–∞: <b>${roomId}</b></p>
     <button onclick="shareInvite()">üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</button>`;

  dbRef.child('players').update({[r]:true});
  dbRef.child('players').on('value', snap=>{
    if(Object.keys(snap.val()||{}).length===2) startGame();
  });
}
function shareInvite(){
  const url = location.origin+location.pathname+'?room='+roomId;
  if(tg.shareLink){tg.shareLink(url,'–°—ã–≥—Ä–∞–π —Å–æ –º–Ω–æ–π!')}
  else{navigator.clipboard.writeText(url); alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: '+url)}
}

/* === –∏–≥—Ä–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ === */
let state = {
  players:{chef:{x:2,y:7,item:null}, manager:{x:17,y:7,item:null}},
  orders:[],
  ingredients:[{x:1,y:1,type:'tomato'},{x:1,y:13,type:'dough'}],
  plates:[{x:9,y:7,status:'empty'}],
  score:0,
  timer:120
};

/* === —Å—Ç–∞—Ä—Ç === */
function startGame(){
  document.getElementById('rolePick').style.display='none';
  dbRef.on('value', snap=>{
    if(snap.exists()) state = snap.val();
    render();
  });

  /* —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
  window.addEventListener('keydown', e=>{
    const me = state.players[role];
    if(!me) return;
    let dx=0,dy=0;
    if(e.key==='ArrowUp'||e.key==='w'||e.key==='W') dy=-1;
    if(e.key==='ArrowDown'||e.key==='s'||e.key==='S') dy=1;
    if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A') dx=-1;
    if(e.key==='ArrowRight'||e.key==='d'||e.key==='D') dx=1;
    if(dx||dy){
      const nx=me.x+dx, ny=me.y+dy;
      if(nx>=0&&nx<W&&ny>=0&&ny<H){
        me.x=nx; me.y=ny;
        checkInteraction();
        dbRef.child('players').update(state.players);
      }
    }
  });

  /* —Ç–∞–π–º–µ—Ä */
  setInterval(()=>{
    if(state.timer>0){
      state.timer--;
      dbRef.update({timer:state.timer});
      document.getElementById('timer').textContent = state.timer;
    }
  },1000);
}

/* === –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è === */
function checkInteraction(){
  const me = state.players[role];
  const on = (arr,prop) => arr.find(o=>o.x===me.x&&o.y===me.y);
  /* –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç ‚Üí –≤ —Ä—É–∫–∏ */
  const ing = on(state.ingredients,'type');
  if(ing && !me.item){
    me.item = ing.type;
    state.ingredients = state.ingredients.filter(i=>i!==ing);
    dbRef.update({ingredients:state.ingredients});
  }
  /* –ø–ª–∏—Ç–∞ ‚Üí –≥–æ—Ç–æ–≤–∏–º */
  const plate = on(state.plates,'status');
  if(plate && me.item){
    if(plate.status==='empty'){
      plate.status = 'cooking_'+me.item;
      me.item = null;
      dbRef.update({plates:state.plates});
      setTimeout(()=>{
        plate.status='ready';
        dbRef.update({plates:state.plates});
      },3000);
    }
  }
  /* –≤—ã–¥–∞—á–∞ –∫–ª–∏–µ–Ω—Ç—É (–º–µ–Ω–µ–¥–∂–µ—Ä) */
  if(role==='manager' && plate && plate.status==='ready'){
    state.score += 10;
    plate.status='empty';
    dbRef.update({score:state.score, plates:state.plates});
    document.getElementById('score').textContent = state.score;
  }
}

/* === —Ä–∏—Å—É–µ–º === */
function render(){
  ctx.fillStyle='#222'; ctx.fillRect(0,0,canvas.width,canvas.height);

  /* —Å—Ç–æ–ª—ã */
  ctx.fillStyle='#555';
  for(let i=0;i<W;i++) for(let j=0;j<H;j++) ctx.fillRect(i*TILE,j*TILE,TILE-1,TILE-1);

  /* –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã */
  state.ingredients.forEach(i=>{
    ctx.fillStyle = i.type==='tomato' ? '#f44336' : '#ffeb3b';
    ctx.fillRect(i.x*TILE+5,i.y*TILE+5,TILE-10,TILE-10);
  });

  /* –ø–ª–∏—Ç—ã */
  state.plates.forEach(p=>{
    ctx.fillStyle = p.status==='empty' ? '#999' : p.status.includes('cooking') ? '#ff9800' : '#4caf50';
    ctx.fillRect(p.x*TILE+5,p.y*TILE+5,TILE-10,TILE-10);
  });

  /* –∏–≥—Ä–æ–∫–∏ */
  ['chef','manager'].forEach(r=>{
    const p = state.players[r];
    if(!p) return;
    ctx.fillStyle = r==='chef' ? '#ff7043' : '#81c784';
    ctx.fillRect(p.x*TILE+2,p.y*TILE+2,TILE-4,TILE-4);
    if(p.item){
      ctx.fillStyle='#fff';
      ctx.fillRect(p.x*TILE+TILE/2-4,p.y*TILE+TILE/2-4,8,8);
    }
  });
}
</script>
</body>
</html>
